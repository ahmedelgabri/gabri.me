---
import {getAllPosts, getPostBySlug} from '../../lib/content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Logo from '../../components/Logo'
import {SettingsPopover} from '../../components/Header/SettingsPopover'
import YouTube from '../../components/YouTube'
import siteMeta from '../../config/siteMeta'

export async function getStaticPaths() {
	const posts = await getAllPosts()
	return posts.map((post) => ({
		params: {slug: post.slug},
	}))
}

const {slug} = Astro.params
const post = await getPostBySlug(slug!, 'blog')

if (!post) {
	return Astro.redirect('/404')
}

const {date, title, formattedDate, url, excerpt} = post
const postUrl = `${siteMeta.siteUrl}${url}`

const {
	social: {
		twitter: {display: twitterDisplay, url: twitterUrl},
	},
} = siteMeta

// Dynamic MDX import
const MDXContent = (await import(`../../_content/blog/${slug}/post.mdx`)).default

const components = {
	YouTube,
}
---

<BaseLayout
	title={title}
	description={excerpt}
	canonicalUrl={postUrl}
	ogType="article"
>
	<header class="mb-12 flex items-center justify-between gap-4">
		<div class="min-w-0 flex-1">
			<Logo slug={slug} />
		</div>
		<SettingsPopover client:load />
	</header>

	<article>
		<header class="mb-8">
			<h2
				class="mb-4 font-bold text-neutral-900 dark:text-neutral-100 text-2xl"
				transition:name={`post-title-${slug}`}
			>
				{title}
			</h2>
			<time class="text-sm text-neutral-500" datetime={date}>
				<i class="i-tabler:calendar mr-1 inline-block align-[-2px]"></i>
				{formattedDate}
			</time>
		</header>

		<div class="prose">
			<MDXContent components={components} />
		</div>

		<div class="my-8 border-t border-neutral-300 pt-8 text-sm dark:border-neutral-700">
			You can
			<a
				href={`https://twitter.com/share?url=${postUrl}&via=${twitterDisplay.slice(1)}&text=${title}`}
				rel="noopener noreferrer"
				target="_blank"
			>
				<i class="i-tabler:brand-twitter mr-1 inline-block align-[-2px]"></i>
				tweet
			</a>
			this post or reach out to me on
			<a href={twitterUrl} rel="noopener noreferrer" target="_blank">
				<i class="i-tabler:brand-twitter mr-1 inline-block align-[-2px]"></i>
				{twitterDisplay}
			</a>.
		</div>
	</article>

	<footer class="border-t border-neutral-300 pt-6 text-sm text-neutral-500 dark:border-neutral-700">
		&copy; {new Date().getFullYear()} {siteMeta.author}
	</footer>
</BaseLayout>
